<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>世界南科成家基金</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="南科存款">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (Remove crossorigin for better local file support) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide React Icons (Fixed Version) -->
    <script src="https://unpkg.com/lucide-react@0.468.0/dist/umd/lucide-react.min.js"></script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Safely access Icons from global window.lucideReact
        // If lucideReact fails to load, we provide a fallback to avoid crashing entirely, 
        // though the UI will lack icons.
        const LucideIcons = window.lucideReact || {};
        const { 
            CheckCircle2, Circle, TrendingUp, PiggyBank, Calendar, AlertCircle, Wallet, 
            Clock, Edit2, Save, X, History, ArrowRight, DollarSign, Calculator, Check, 
            Home, Building2, UserCircle2, PieChart, Coins 
        } = LucideIcons;

        // --- Configuration & Data Logic ---

        const MILESTONE_COSTS = {
            '2023-10-01': { name: '訂金+簽約金', cost: 580000, payer: 'shuan' },
            '2024-01-01': { name: '1樓底板工程', cost: 480000, payer: 'shuan' },
            '2025-07-01': { name: '13樓底板+RC', cost: 220000 },
            '2026-04-01': { name: '結構體上樑', cost: 950000 },
            '2027-04-01': { name: '2027年度工程款', cost: 950000 },
            '2028-04-01': { name: '交屋款', cost: 800000 },
            '2028-06-01': { name: '暫收款', cost: 250000 }
        };

        const generateData = () => {
            const data = [];
            let startDate = new Date(2023, 9, 1); // 2023-10
            let endDate = new Date(2028, 12, 1);  // 2029-01 (End of 2028)
            let currentDate = new Date(startDate);
            let idCounter = 1;

            // 0. 初期資金/調整 (為了補足 2025/12 的差額)
            data.push({
                id: idCounter++,
                type: 'income',
                subType: 'adjustment',
                label: '初期資金/帳戶校正',
                date: '2023-09-30',
                yaoAmount: 310000,
                shuanAmount: 125000,
                yaoPaidDate: null, 
                shuanPaidDate: null,
            });

            while (currentDate <= endDate) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const dateStr = `${year}-${month.toString().padStart(2, '0')}-01`;
                
                // 1. 月存
                data.push({
                    id: idCounter++,
                    type: 'income',
                    subType: 'monthly',
                    label: `${year}年 ${month}月存款`,
                    date: dateStr,
                    yaoAmount: 20000,
                    shuanAmount: 10000,
                    yaoPaidDate: null,
                    shuanPaidDate: null,
                });

                // 2. 季度分紅
                if (month === 2 || month === 5 || month === 8 || month === 11) {
                    data.push({
                        id: idCounter++,
                        type: 'income',
                        subType: 'bonus',
                        label: `${year}年 ${month}月分紅`,
                        date: dateStr,
                        yaoAmount: 50000,
                        shuanAmount: 30000,
                        yaoPaidDate: null,
                        shuanPaidDate: null,
                    });
                }

                // 3. 年終
                if (month === 12) {
                    data.push({
                        id: idCounter++,
                        type: 'income',
                        subType: 'year-end',
                        label: `${year}年 年終獎金`,
                        date: dateStr,
                        yaoAmount: 90000,
                        shuanAmount: 60000,
                        yaoPaidDate: null,
                        shuanPaidDate: null,
                    });
                }

                // 4. 工程款
                const milestone = MILESTONE_COSTS[dateStr];
                if (milestone) {
                    let paidDate = null;
                    let paidDetails = { yao: 0, shuan: 0 };
                    
                    if (milestone.payer === 'shuan') {
                        paidDate = dateStr;
                        paidDetails.shuan = milestone.cost;
                    }

                    data.push({
                        id: idCounter++,
                        type: 'expense',
                        label: milestone.name,
                        cost: milestone.cost,
                        date: dateStr,
                        paidDate: paidDate,
                        paidDetails: paidDetails, 
                    });
                }

                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            // Sort: Same date -> Expense first, Income last
            return data.sort((a, b) => {
                const dateDiff = new Date(a.date) - new Date(b.date);
                if (dateDiff !== 0) return dateDiff;
                if (a.type !== b.type) {
                    return a.type === 'expense' ? -1 : 1;
                }
                return 0;
            });
        };

        const App = () => {
            const [handoverDate, setHandoverDate] = useState('2028-04-30');
            const [isEditingHandover, setIsEditingHandover] = useState(false);
            const [tempHandoverDate, setTempHandoverDate] = useState('2028-04-30');

            const [totalHousePrice, setTotalHousePrice] = useState(15910000); 
            const [isEditingPrice, setIsEditingPrice] = useState(false);
            const [tempPrice, setTempPrice] = useState(15910000);

            const [editingTransaction, setEditingTransaction] = useState(null);
            const [editValue, setEditValue] = useState('');
            const [expenseInput, setExpenseInput] = useState({ yao: '', shuan: '' });

            // Generate Manifest dynamically for PWA
            useEffect(() => {
                const manifest = {
                    name: "世界南科存款",
                    short_name: "南科存款",
                    start_url: ".",
                    display: "standalone",
                    background_color: "#f8fafc",
                    theme_color: "#e11d48",
                    icons: [
                        { src: "icon.png", sizes: "192x192", type: "image/png" },
                        { src: "icon.png", sizes: "512x512", type: "image/png" }
                    ]
                };
                const stringManifest = JSON.stringify(manifest);
                const blob = new Blob([stringManifest], {type: 'application/json'});
                const manifestURL = URL.createObjectURL(blob);
                
                let linkManifest = document.querySelector('link[rel="manifest"]');
                if (!linkManifest) {
                    linkManifest = document.createElement('link');
                    linkManifest.rel = 'manifest';
                    document.head.appendChild(linkManifest);
                }
                linkManifest.href = manifestURL;
            }, []);

            const [transactions, setTransactions] = useState(() => {
                const initialData = generateData();
                const cutoffDate = new Date(); // Today
                return initialData.map(item => {
                    const itemDate = new Date(item.date);
                    // Pre-check income items before today
                    if (itemDate <= cutoffDate && item.type === 'income') {
                        return { ...item, yaoPaidDate: item.date, shuanPaidDate: item.date };
                    }
                    return item;
                });
            });

            const formatMoney = (amount) => {
                return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
            };

            const getTodayString = () => {
                const today = new Date();
                return today.toISOString().split('T')[0];
            };

            // Actions
            const startEditing = (item, person) => {
                const currentAmount = person === 'yao' ? item.yaoAmount : item.shuanAmount;
                setEditingTransaction({ id: item.id, person });
                setEditValue(currentAmount.toString());
            };

            const cancelEditing = () => {
                setEditingTransaction(null);
                setEditValue('');
            };

            const confirmSaving = (id, person) => {
                const newAmount = parseInt(editValue, 10);
                if (isNaN(newAmount)) return;

                setTransactions(prev => prev.map(item => {
                    if (item.id === id && item.type === 'income') {
                        const dateField = person === 'yao' ? 'yaoPaidDate' : 'shuanPaidDate';
                        const amountField = person === 'yao' ? 'yaoAmount' : 'shuanAmount';
                        return {
                            ...item,
                            [amountField]: newAmount,
                            [dateField]: getTodayString()
                        };
                    }
                    return item;
                }));
                setEditingTransaction(null);
            };

            const undoSaving = (id, person) => {
                setTransactions(prev => prev.map(item => {
                    if (item.id === id && item.type === 'income') {
                        const field = person === 'yao' ? 'yaoPaidDate' : 'shuanPaidDate';
                        return { ...item, [field]: null };
                    }
                    return item;
                }));
            };

            const confirmExpense = (id, cost) => {
                const yaoPay = parseInt(expenseInput.yao || 0, 10);
                const shuanPay = parseInt(expenseInput.shuan || 0, 10);
                
                if (yaoPay + shuanPay <= 0) {
                    if (!window.confirm("未輸入任何繳款金額，確定要標記為已支付嗎？(將視為直接從公基金扣款)")) {
                        return;
                    }
                }

                setTransactions(prev => prev.map(item => {
                    if (item.id === id && item.type === 'expense') {
                        return {
                            ...item,
                            paidDate: getTodayString(),
                            paidDetails: { yao: yaoPay, shuan: shuanPay }
                        };
                    }
                    return item;
                }));
                setExpenseInput({ yao: '', shuan: '' });
            };

            // Stats
            const stats = useMemo(() => {
                let yaoSaved = 0;   
                let shuanSaved = 0; 
                let yaoPaidDirectly = 0;   
                let shuanPaidDirectly = 0; 
                let totalExpensePaid = 0;
                let totalPlannedCost = 0; 

                transactions.forEach(t => {
                    if (t.type === 'income') {
                        if (t.yaoPaidDate) yaoSaved += t.yaoAmount;
                        if (t.shuanPaidDate) shuanSaved += t.shuanAmount;
                    } else if (t.type === 'expense') {
                        totalPlannedCost += t.cost;
                        if (t.paidDate) {
                            totalExpensePaid += t.cost;
                            if (t.paidDetails) {
                                yaoPaidDirectly += (t.paidDetails.yao || 0);
                                shuanPaidDirectly += (t.paidDetails.shuan || 0);
                            }
                        }
                    }
                });

                const expensesPaidFromPool = totalExpensePaid - (yaoPaidDirectly + shuanPaidDirectly);
                const currentPool = (yaoSaved + shuanSaved) - expensesPaidFromPool;

                return {
                    yaoSaved,
                    shuanSaved,
                    yaoPaidDirectly,
                    shuanPaidDirectly,
                    currentPool,
                    totalExpensePaid,
                    totalPlannedCost,
                    loanAmount: totalHousePrice - totalPlannedCost
                };
            }, [transactions, totalHousePrice]);

            const breakdown = useMemo(() => {
                const result = {
                    yao: { adjustment: 0, monthly: 0, bonus: 0, yearEnd: 0, total: 0 },
                    shuan: { adjustment: 0, monthly: 0, bonus: 0, yearEnd: 0, total: 0 }
                };
                
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        if (t.yaoPaidDate) {
                            if (t.subType === 'adjustment') result.yao.adjustment += t.yaoAmount;
                            else if (t.subType === 'monthly') result.yao.monthly += t.yaoAmount;
                            else if (t.subType === 'bonus') result.yao.bonus += t.yaoAmount;
                            else if (t.subType === 'year-end') result.yao.yearEnd += t.yaoAmount;
                        }
                        
                        if (t.shuanPaidDate) {
                            if (t.subType === 'adjustment') result.shuan.adjustment += t.shuanAmount;
                            else if (t.subType === 'monthly') result.shuan.monthly += t.shuanAmount;
                            else if (t.subType === 'bonus') result.shuan.bonus += t.shuanAmount;
                            else if (t.subType === 'year-end') result.shuan.yearEnd += t.shuanAmount;
                        }
                    }
                });
                
                result.yao.total = result.yao.adjustment + result.yao.monthly + result.yao.bonus + result.yao.yearEnd;
                result.shuan.total = result.shuan.adjustment + result.shuan.monthly + result.shuan.bonus + result.shuan.yearEnd;
                
                return result;
            }, [transactions]);

            const nextExpense = useMemo(() => {
                return transactions.find(t => t.type === 'expense' && !t.paidDate);
            }, [transactions]);

            const balanceStatus = useMemo(() => {
                if (!nextExpense) return { status: 'all_clear', diff: 0 };
                const currentInputTotal = (parseInt(expenseInput.yao || 0) + parseInt(expenseInput.shuan || 0));
                const remainingCostFromPool = Math.max(0, nextExpense.cost - currentInputTotal);
                const diff = stats.currentPool - remainingCostFromPool;
                return {
                    status: diff >= 0 ? 'sufficient' : 'insufficient',
                    diff: diff
                };
            }, [stats.currentPool, nextExpense, expenseInput]);

            const countdown = useMemo(() => {
                const target = new Date(handoverDate);
                const today = new Date();
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays > 0 ? diffDays : 0;
            }, [handoverDate]);

            const saveHandoverDate = () => {
                setHandoverDate(tempHandoverDate);
                setIsEditingHandover(false);
            };
            
            const savePrice = () => {
                setTotalHousePrice(tempPrice);
                setIsEditingPrice(false);
            };

            const renderSavingButton = (item, person) => {
                const isYao = person === 'yao';
                const isPaid = isYao ? item.yaoPaidDate : item.shuanPaidDate;
                const amount = isYao ? item.yaoAmount : item.shuanAmount;
                const isEditing = editingTransaction?.id === item.id && editingTransaction?.person === person;

                if (isEditing) {
                    return (
                        <div className="flex items-center gap-1 bg-white p-1 rounded-lg border border-blue-300 shadow-sm animate-in fade-in zoom-in duration-200">
                            <input
                                type="number"
                                value={editValue}
                                onChange={(e) => setEditValue(e.target.value)}
                                className="w-20 text-sm p-1 border rounded bg-slate-50 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                autoFocus
                            />
                            <button onClick={() => confirmSaving(item.id, person)} className="p-1 bg-green-500 text-white rounded hover:bg-green-600">
                                {Check && <Check size={16} />}
                            </button>
                            <button onClick={cancelEditing} className="p-1 bg-slate-200 text-slate-500 rounded hover:bg-slate-300">
                                {X && <X size={16} />}
                            </button>
                        </div>
                    );
                }

                return (
                    <button 
                        onClick={() => isPaid ? undoSaving(item.id, person) : startEditing(item, person)}
                        className={`flex items-center gap-2 px-3 py-2 rounded-lg border transition-all min-w-[100px] justify-between ${
                            isPaid 
                                ? 'bg-green-100 border-green-200 text-green-800' 
                                : 'bg-white border-slate-200 text-slate-400 hover:border-blue-400 hover:bg-blue-50'
                        }`}
                    >
                        <span className="text-sm font-bold text-slate-600">{isYao ? '堯' : '璇'}</span>
                        <div className="text-right">
                            <span className="block text-xs font-bold font-mono">{formatMoney(amount)}</span>
                            <span className="block text-[10px] opacity-70">{isPaid ? '已入帳' : '確認存款'}</span>
                        </div>
                    </button>
                );
            };

            return (
                <div className="max-w-4xl mx-auto space-y-6 p-4">
                    {/* Header */}
                    <div className="bg-white rounded-2xl shadow-sm p-6 border-l-4 border-rose-500">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                    {PiggyBank && <PiggyBank className="text-rose-500" />}
                                    世界南科成家基金
                                </h1>
                                <div className="flex items-center gap-2 mt-1">
                                    {Building2 && <Building2 size={14} className="text-slate-400" />}
                                    <span className="text-sm text-slate-500">房屋總價: </span>
                                    {isEditingPrice ? (
                                        <div className="flex items-center gap-1">
                                            <input 
                                                type="number" 
                                                value={tempPrice} 
                                                onChange={(e) => setTempPrice(Number(e.target.value))} 
                                                className="w-32 text-sm p-1 border rounded bg-slate-50"
                                            />
                                            <button onClick={savePrice} className="text-green-600">{Save && <Save size={14}/>}</button>
                                            <button onClick={() => setIsEditingPrice(false)} className="text-red-500">{X && <X size={14}/>}</button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-1 group cursor-pointer" onClick={() => { setTempPrice(totalHousePrice); setIsEditingPrice(true); }}>
                                            <span className="text-sm font-bold text-slate-700 underline decoration-slate-300 decoration-dotted underline-offset-4">{formatMoney(totalHousePrice)}</span>
                                            {Edit2 && <Edit2 size={12} className="text-slate-300 group-hover:text-rose-400" />}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            <div className="bg-rose-50 px-4 py-3 rounded-xl flex items-center gap-4 w-full md:w-auto">
                                <div className="bg-rose-100 p-2 rounded-lg">
                                    {Clock && <Clock className="text-rose-600" size={24} />}
                                </div>
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-xs font-bold text-rose-400 uppercase tracking-wide">交屋倒數</span>
                                        {!isEditingHandover && (
                                            <button onClick={() => { setTempHandoverDate(handoverDate); setIsEditingHandover(true); }} className="text-slate-400 hover:text-rose-500 transition-colors">
                                                {Edit2 && <Edit2 size={14} />}
                                            </button>
                                        )}
                                    </div>
                                    {isEditingHandover ? (
                                        <div className="flex items-center gap-2">
                                            <input type="date" value={tempHandoverDate} onChange={(e) => setTempHandoverDate(e.target.value)} className="text-sm p-1 border rounded" />
                                            <button onClick={saveHandoverDate} className="text-green-600">{Save && <Save size={16}/>}</button>
                                            <button onClick={() => setIsEditingHandover(false)} className="text-red-500">{X && <X size={16}/>}</button>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col">
                                            <div className="flex items-baseline gap-1">
                                                <span className="text-2xl font-bold text-rose-700">{countdown}</span>
                                                <span className="text-sm text-rose-600">天</span>
                                            </div>
                                            <span className="text-xs text-rose-400 mt-1">預計: {handoverDate}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Financial Overview */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-slate-800 text-slate-200 rounded-2xl p-5 shadow-sm md:col-span-2 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-slate-700 p-3 rounded-full">
                                    {Home && <Home className="text-blue-400" size={24} />}
                                </div>
                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase">已知自備款/工程款總額</h3>
                                    <div className="text-2xl font-bold text-white">{formatMoney(stats.totalPlannedCost)}</div>
                                </div>
                            </div>
                            <div className="hidden md:block w-px h-10 bg-slate-600"></div>
                            <div className="flex items-center gap-4">
                                <div>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase text-right">預估貸款金額</h3>
                                    <div className="text-2xl font-bold text-emerald-400">{formatMoney(stats.loanAmount)}</div>
                                    <div className="text-[10px] text-slate-500 text-right">(總價 - 自備款)</div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 flex flex-col justify-center space-y-4 md:col-span-1">
                            <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 flex items-center gap-1">
                                個人累積存款 <span className="text-[10px] text-slate-400 font-normal">(不含自付工程款)</span>
                            </h2>
                            <div className="flex justify-between items-center px-2">
                                <span className="text-lg font-bold text-slate-700">堯</span>
                                <div className="text-right">
                                    <span className="block text-sm font-bold text-blue-600 font-mono">{formatMoney(stats.yaoSaved)}</span>
                                    {stats.yaoPaidDirectly > 0 && <span className="block text-[10px] text-slate-400">另自付: {formatMoney(stats.yaoPaidDirectly)}</span>}
                                </div>
                            </div>
                            <div className="w-full h-px bg-slate-100"></div>
                            <div className="flex justify-between items-center px-2">
                                <span className="text-lg font-bold text-slate-700">璇</span>
                                <div className="text-right">
                                    <span className="block text-sm font-bold text-pink-600 font-mono">{formatMoney(stats.shuanSaved)}</span>
                                    {stats.shuanPaidDirectly > 0 && <span className="block text-[10px] text-slate-400">另自付: {formatMoney(stats.shuanPaidDirectly)}</span>}
                                </div>
                            </div>
                        </div>

                        <div className="bg-gradient-to-br from-indigo-600 to-blue-700 rounded-2xl p-6 text-white shadow-lg md:col-span-1 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10">
                                {Wallet && <Wallet size={120} />}
                            </div>
                            <div className="relative z-10">
                                <h2 className="text-indigo-100 text-sm font-medium mb-1 flex items-center gap-2">
                                    {Calculator && <Calculator size={16} />} 目前公基金餘額 (現金)
                                </h2>
                                <p className="text-4xl font-bold mb-4 tracking-tight">{formatMoney(stats.currentPool)}</p>
                                
                                <div className="flex flex-col sm:flex-row gap-4 text-xs text-indigo-200 bg-indigo-800/30 p-3 rounded-lg w-fit">
                                    <div>
                                        <span className="block opacity-70">兩人總存款</span>
                                        <span className="font-bold">{formatMoney(stats.yaoSaved + stats.shuanSaved)}</span>
                                    </div>
                                    <div className="hidden sm:block w-px bg-indigo-500/50"></div>
                                    <div>
                                        <span className="block opacity-70">公基金已支出</span>
                                        <span className="font-bold">{formatMoney(stats.totalExpensePaid - (stats.yaoPaidDirectly + stats.shuanPaidDirectly))}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Breakdown Chart */}
                    <div className="bg-slate-50 border border-slate-200 rounded-2xl p-5 shadow-sm">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-4">
                            {PieChart && <PieChart size={18} className="text-purple-500"/>} 目前資金結構 (已實際入帳)
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white p-4 rounded-xl border border-slate-100">
                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                                    <span className="font-bold text-slate-700">堯</span>
                                    <span className="font-bold text-blue-600">{formatMoney(breakdown.yao.total)}</span>
                                </div>
                                <div className="space-y-2 text-sm text-slate-600">
                                    <div className="flex justify-between">
                                        <span>月存累積</span>
                                        <span className="font-mono">{formatMoney(breakdown.yao.monthly)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>季度分紅</span>
                                        <span className="font-mono">{formatMoney(breakdown.yao.bonus)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>年終獎金</span>
                                        <span className="font-mono">{formatMoney(breakdown.yao.yearEnd)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-400">
                                        <span>初期資金/校正</span>
                                        <span className="font-mono">{formatMoney(breakdown.yao.adjustment)}</span>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-100">
                                <div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                                    <span className="font-bold text-slate-700">璇</span>
                                    <span className="font-bold text-pink-600">{formatMoney(breakdown.shuan.total)}</span>
                                </div>
                                <div className="space-y-2 text-sm text-slate-600">
                                    <div className="flex justify-between">
                                        <span>月存累積</span>
                                        <span className="font-mono">{formatMoney(breakdown.shuan.monthly)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>季度分紅</span>
                                        <span className="font-mono">{formatMoney(breakdown.shuan.bonus)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>年終獎金</span>
                                        <span className="font-mono">{formatMoney(breakdown.shuan.yearEnd)}</span>
                                    </div>
                                    <div className="flex justify-between text-xs text-slate-400">
                                        <span>初期資金/校正</span>
                                        <span className="font-mono">{formatMoney(breakdown.shuan.adjustment)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Next Expense */}
                    {nextExpense ? (
                        <div className="bg-white rounded-2xl shadow-md border-t-4 border-amber-400 overflow-hidden">
                            <div className="p-6">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                    <div>
                                        <h2 className="text-slate-500 text-sm font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                                            {AlertCircle && <AlertCircle size={16} className="text-amber-500" />} 下一期應繳工程款
                                        </h2>
                                        <div className="flex items-baseline gap-3">
                                            <span className="text-3xl font-bold text-slate-800">{nextExpense.label}</span>
                                            <span className="text-sm text-slate-400 font-mono">預計日期: {nextExpense.date}</span>
                                        </div>
                                    </div>
                                    
                                    <div className={`px-4 py-3 rounded-xl border flex flex-col items-end min-w-[180px] ${
                                        balanceStatus.status === 'sufficient' 
                                            ? 'bg-green-50 border-green-200 text-green-700' 
                                            : 'bg-red-50 border-red-200 text-red-700'
                                    }`}>
                                        <span className="text-xs font-bold uppercase mb-1">資金預估</span>
                                        <div className="flex items-center gap-1">
                                            <span className="text-lg font-bold">
                                                {balanceStatus.diff >= 0 ? '+' : ''}{formatMoney(balanceStatus.diff)}
                                            </span>
                                        </div>
                                        <span className="text-xs opacity-80">
                                            {balanceStatus.status === 'sufficient' ? '足夠支付' : '資金不足'}
                                        </span>
                                    </div>
                                </div>

                                <div className="bg-slate-50 rounded-xl p-4 border border-slate-100">
                                    <div className="mb-4 flex items-center gap-3">
                                        <div className="bg-white p-2 rounded-full shadow-sm border">
                                            {DollarSign && <DollarSign className="text-amber-600" />}
                                        </div>
                                        <div>
                                            <span className="block text-sm text-slate-500">本期應繳總金額</span>
                                            <span className="block text-xl font-bold text-slate-800">{formatMoney(nextExpense.cost)}</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">堯 自付/代墊 (若不從公基金扣)</label>
                                            <input 
                                                type="number" 
                                                placeholder="輸入金額" 
                                                value={expenseInput.yao}
                                                onChange={(e) => setExpenseInput(prev => ({...prev, yao: e.target.value}))}
                                                className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">璇 自付/代墊 (若不從公基金扣)</label>
                                            <input 
                                                type="number" 
                                                placeholder="輸入金額" 
                                                value={expenseInput.shuan}
                                                onChange={(e) => setExpenseInput(prev => ({...prev, shuan: e.target.value}))}
                                                className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-amber-500 outline-none"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div className="flex justify-end">
                                        <button 
                                            onClick={() => confirmExpense(nextExpense.id, nextExpense.cost)}
                                            disabled={balanceStatus.status === 'insufficient' && (parseInt(expenseInput.yao||0) + parseInt(expenseInput.shuan||0)) === 0}
                                            className={`px-6 py-3 rounded-lg font-bold flex items-center gap-2 transition-all shadow-sm w-full sm:w-auto justify-center ${
                                                balanceStatus.status === 'sufficient' || (parseInt(expenseInput.yao||0) + parseInt(expenseInput.shuan||0)) > 0
                                                    ? 'bg-amber-500 hover:bg-amber-600 text-white shadow-amber-200'
                                                    : 'bg-slate-300 text-slate-500 cursor-not-allowed'
                                            }`}
                                        >
                                            確認繳款 {ArrowRight && <ArrowRight size={18} />}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-green-100 rounded-2xl p-8 text-center text-green-800 border border-green-200">
                            {CheckCircle2 && <CheckCircle2 size={48} className="mx-auto mb-3" />}
                            <h2 className="text-2xl font-bold">所有工程款項皆已支付完畢！</h2>
                        </div>
                    )}

                    {/* History List */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 bg-slate-50">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                {History && <History size={18} />} 資金流動歷程
                            </h3>
                        </div>
                        
                        <div className="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
                            {transactions.map((item) => {
                                if (item.subType === 'adjustment') {
                                    return (
                                        <div key={item.id} className="p-4 bg-slate-100 border-l-4 border-slate-400">
                                            <div className="flex items-center gap-4">
                                                <div className="p-2 bg-white rounded-lg text-slate-500">{Wallet && <Wallet size={20} />}</div>
                                                <div>
                                                    <p className="font-bold text-slate-800">{item.label}</p>
                                                    <p className="text-xs text-slate-500">日期: {item.date}</p>
                                                </div>
                                                <div className="flex-1 text-right text-xs font-mono text-slate-500">
                                                    <span className="mr-3">堯補正: {formatMoney(item.yaoAmount)}</span>
                                                    <span>璇補正: {formatMoney(item.shuanAmount)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    )
                                }

                                if (item.type === 'expense') {
                                    return (
                                        <div key={item.id} className={`p-4 ${item.paidDate ? 'bg-amber-50/40' : 'bg-white'}`}>
                                            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                                <div className="flex items-center gap-4">
                                                    <div className={`p-2 rounded-lg ${item.paidDate ? 'bg-amber-200 text-amber-800' : 'bg-slate-100 text-slate-400'}`}>
                                                        {AlertCircle && <AlertCircle size={24} />}
                                                    </div>
                                                    <div>
                                                        <p className="font-bold text-slate-800">{item.label}</p>
                                                        <p className="text-xs text-slate-500">日期: {item.date}</p>
                                                        <p className="text-sm font-bold text-red-600 mt-1">費用: {formatMoney(item.cost)}</p>
                                                    </div>
                                                </div>

                                                {item.paidDate ? (
                                                    <div className="flex flex-col items-end min-w-[120px]">
                                                        <span className="flex items-center gap-1 text-green-600 font-bold text-sm">
                                                            {CheckCircle2 && <CheckCircle2 size={16} />} 已支付
                                                        </span>
                                                        {item.paidDetails && (item.paidDetails.yao > 0 || item.paidDetails.shuan > 0) ? (
                                                            <div className="text-xs text-slate-500 mt-1 text-right">
                                                                {item.paidDetails.yao > 0 && <div>堯自付: {formatMoney(item.paidDetails.yao)}</div>}
                                                                {item.paidDetails.shuan > 0 && <div>璇自付: {formatMoney(item.paidDetails.shuan)}</div>}
                                                            </div>
                                                        ) : (
                                                            <div className="text-[10px] text-slate-400 mt-1">由公基金支付</div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div className="px-3 py-1 bg-slate-100 text-slate-500 text-xs rounded-full self-start sm:self-center">
                                                        待支付
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                }

                                const isFullySaved = item.yaoPaidDate && item.shuanPaidDate;
                                return (
                                    <div key={item.id} className={`p-4 hover:bg-slate-50 transition-colors ${isFullySaved ? 'bg-green-50/30' : ''}`}>
                                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                            <div className="flex items-center gap-4 min-w-[200px]">
                                                <div className={`p-2 rounded-lg ${item.subType === 'bonus' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'}`}>
                                                    {item.subType === 'bonus' && Wallet ? <Wallet size={20} /> : (Calendar && <Calendar size={20} />)}
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-700">{item.label}</p>
                                                    <p className="text-xs text-slate-400">合計存入: {formatMoney(item.yaoAmount + item.shuanAmount)}</p>
                                                </div>
                                            </div>

                                            <div className="flex gap-2 sm:gap-4 flex-1 justify-end items-center">
                                                {renderSavingButton(item, 'yao')}
                                                {renderSavingButton(item, 'shuan')}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>